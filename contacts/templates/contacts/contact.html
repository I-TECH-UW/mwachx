{% extends 'base.html' %} {% load staticfiles %}  
{% block title %}Participant: {{contact.nickname}}{% endblock %} 

{% block content %}

{% include 'modals/send-message-modal.html' %}
{% include 'modals/participant-details-modal.html' %}
{% include 'modals/add-note-modal.html' %}
{% include 'modals/add-new-visit-modal.html' %}

<div class="page-content" id="participant-page">
<div class="row">
    <h1 id='participant-details'>
        <span>
        <i class="mw {% if contact.status == 'post' %}mw-mwach-baby-phone{% else %}mw-mwach-phone{% endif %}"></i> 
        {{contact.nickname}}
        </span> 
        <small>{{contact.study_id_short}}</small> <small>{{contact.anc_num}}</small>    
    </h1>
</div>
    <div class="row">
        <div class="col-md-8">
            <div class='btn-group btn-group-justified' id='msg-list-btn-group'>
                <a data-toggle='modal' data-target='#sendModal' class='action-item btn btn-success'><span class="action-item-icon"><i class="mw mw-comment"></i></span> <span class="action-item-text">Send Message</span></a>
                <a class='action-item btn btn-highlight'><span class="action-item-icon"><i class="mw mw-mobile-1"></i></span> <span class="action-item-text">Record Call</span></a>
            </div>
            <div class="infinitescroll" id="messagesList">
                {% for message in contact.message_set.all %}
                <div class="row skinny-row scroll-row">
                    {% if message.html_class == "client" %}
                    <!-- TODO: Get this to bo to the bottom of the row -->
                    <div class="col-md-1 avatar-participant mw-4x"><i class="mw {% if message.is_pregnant %}mw-mwach-phone{% else %}mw-mwach-baby-phone{% endif %}"></i></div>
                    <div class='col-md-9 message {{message.html_class}}'>
                    {% else %}
                    <div class='col-md-9 col-md-offset-2 message {{message.html_class}}'>
                    {% endif %}
                        <div class='msg-header'>
                            <div class="header-item"><span><strong>{{message.sent_by}}</strong> ({{message.weeks}} wk)</span></div>
                            <div class="header-item translation-info">
                            {% if message.is_translated %}
                                    {% if not message.translation_skipped %}
                                    <div class="checkbox-toggle" data-toggle="buttons-checkbox">
                                        <input type="checkbox" name="onoffswitch" id="transToggle{{message.id}}" data-toggle="button" checked>
                                        <label class="btn btn-language btn-sm active transLabel" for="transToggle{{message.id}}" data-content-id="content{{message.id}}" data-content-translated="{{message.get_real_text}}" data-content-original="{{message.get_original_text}}" data-toggle="tooltip" data-placement="top" title="Toggle between original message and translation"><i class="mw mw-language-1 mw-lg"></i></label>
                                    </div>
                                    {% else %}
                                    <span>(Translation skipped)</span>
                                    {% endif %}
                                    <button class='btn btn-sm btn-default btn-redo' data-toggle="tooltip" data-placement="top" title="Mark for retranslation" data-msg-id="{{message.id}}">
                                        <i class="mw mw-redo"></i>
                                    </button>
                            {% elif message.is_translation_pending %}
                                {% include 'contact_blocks/untranslated.html' %}
                            {% endif %}
                            </div>
                            
                            <div class="header-item date"><span>{{ message.created|date:"n N y H:i" }}</span></div>
                        </div>
                        <div class='content' id="content{{message.id}}">{{ message.get_real_text }}</div>
                        <div class='footer'>
                            {% if not message.is_outgoing and not message.is_viewed %}
                            <div class="row msg-metadata-row">
                                <div class="col-md-6 table-btns">
                                    <div class="btn-toolbar" role="toolbar" aria-label="...">
                                        <div class="btn-group" data-toggle="buttons" id="lang{{message.id}}" >
                                            {% for l in langs %}
                                                <label onclick="mark_dirty()" class="btn btn-language btn-sm {% if l.id in message.lang_ids %}active{% endif %}" data-toggle="tooltip" data-placement="top" title="{{l.name}}"><input  name='{{l.name}}' type="checkbox" autocomplete="off" value="{{l.id}}"
                                                {% if l.id in message.lang_ids %}checked{% endif %}
                                                >{{l.short_name}}</label>
                                            {% endfor %}
                                        </div>
                                        <div class="btn-group" data-toggle="buttons">
                                            <label class="btn btn-sm btn-language">
                                                <input type="radio" autocomplete="off"> Related
                                            </label>
                                            <label class="btn btn-sm btn-language">
                                                <input type="radio" autocomplete="off"> Unrelated
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-1 table-label">Topic:</div>
                                <div class="col-md-4">
                                    <select name='topic' class='select form-control input-mini'>
                                        <option value='none'>None</option>
                                        <option value='adherence'>Adherence</option>
                                        <option value='side-effects'>Side Effects</option>
                                        <option value='visits'>Visits</option>
                                        <option value='antenatal-concerns'>Antenatal Concerns</option>
                                        <option value='delivery-concenrs'>Delivery Concerns</option>
                                        <option value='family-planing'>Family Planing</option>
                                        <option value='infant-health'>Infant Health</option>
                                        <option value='sexual-behavior'>Sexual Behavior</option>
                                        <option value='other'>Other</option>
                                    </select>
                                </div>
                            </div>
                            {% endif %}
                            {% if not message.is_outgoing %}
                            <div class="col-full">
                            <div class="btn-group btn-group-justified msg-action-btn-grp">
                                <a data-toggle="modal" data-target="#sendModal" data-message-id='{{message.id}}' class="btn btn-sm btn-success"></span> <i class="mw mw-reply"></i> Reply</a>
                                {% if not message.is_viewed %}
                                <a class="btn btn-sm btn-danger" old-href='{% url "contacts.views.message_dismiss" message.id%}'><i class="mw mw-times"></i> Dismiss</a>
                                 {% endif %}
                            </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% if message.html_class == "nurse" %}
                    <div class="col-md-1 avatar-nurse mw-4x"><i class="mw mw-user-md"></i></div>
                    {% elif message.html_class == "system" %}
                    <div class="col-md-1 avatar-system mw-4x"><i class="mw mw-server"></i></div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="col-md-4">
            <div class='panel panel-info'>
                <div class='panel-heading'>
                    <h3 class='panel-title'>Participant Details <i id='context-edit' class='mw mw-cogs pull-right' data-toggle='modal' data-target='#contactDetailsModal'></i></h3>
                </div>
                <table class="details-table table table-condensed">
                    <tr>
                        <td>Partner Name</td>
                        <td id="display_partner_name">{{contact.partner_name}}</td>
                    </tr>
                    <tr>
                        <td>Age</td>
                        <td id="display_age">{{contact.age}}</td>
                    </tr>
                    <tr>
                        <td>Phone Number</td>
                        <td id="display_phone_number">{{contact.phone_number}}</td>
                    </tr>
                    <tr>
                        <td>Relationship Status</td>
                        <td id="display_relationship_status">{{contact.relationship_status}}</td>
                    </tr>
                    <tr>
                        <td>Previous Pregnancies</td>
                        <td id="display_previous_pregnancies">{{contact.previous_pregnancies}}</td>
                    </tr>
                    <tr>
                        <td>SMS Track</td>
                        <td id="display_condition">{{contact.condition}}</td>
                    </tr>
                    <tr>
                        <td>Family Planning</td>
                        <td id="display_family_planning">{{contact.family_planning}}</td>
                    </tr>
                    <tr>
                        <td>ART Initiation</td>
                        <td id="display_art_initiation">{{contact.art_initiation}}</td>
                    </tr>
                    <tr>
                        <td>Due Date</td>
                        <td id="display_due_date">{{contact.due_date}}</td>
                    </tr>
                </table>
            </div>

            <div class='panel panel-info'>
                <div class='panel-heading'>
                    <h3 class='panel-title'>Clinic Visit History</h3>
                </div>
                <div class='panel-body'>
                    <div class='details'>
                        <table class="details-table-offset visit-table table table-condensed">
                            <tr>
                                <td><div class="tooltip-icon" data-toggle="tooltip" data-title="{{contact.nickname}} came to clinic"><a class="btn btn-info" data-toggle='modal' data-target='#visitScheduleModal' data-src={% url 'contacts.views.contacts' %} data-study-id={{contact.study_id}}><i class="mw mw-hospital-o mw-fw"></i></a></div></td>
                                <td>Next Visit</td>
                                <td>{{contact.visit_set.first.scheduled}}</td>
                            </tr>
                        </table>
                        <h3>
                            <a data-toggle="collapse" href='#previous-visits-detail' class="collapsed">
                                Previous Visits ({{contact.get_visits.count}})
                            </a>
                        </h3>
                        <div id='previous-visits-detail' class='extra collapse' data-heading='Previous Visits'>
                            <table class='table table-contable-condensed'>
                                <tr>
                                    <th>Scheduled</th>
                                    <th>Arrived</th>
                                </tr>
                                {% for visit in contact.get_visits %}
                                <tr>
                                    <td>{{visit.scheduled}}</td>
                                    <td>{{visit.arrived}}</td>
                                </tr>
                                {% endfor %}
                            </table>
                        </div>
                    </div>
                </div>

            </div>

            <div class='panel panel-info'>
                <div class='panel-heading'>
                    <h3 class='panel-title'>Clinic Notes<i id='note-add' class='mw mw-plus-squared pull-right' data-toggle='modal' data-target='#addNoteModal'></i></h3>
                </div>
                <div class='panel-body'>
                    <div class='details'>
                        <div class='note'>
                            {{contact.note_set.first.comment}}
                        </div>
                        <h3>
                        <a data-toggle='collapse' href='#previous-notes-detail' class="collapsed">
                            Previous Notes ({{contact.note_set.count}})
                        </a>
                    </h3>
                        <div id='previous-notes-detail' class='extra collapse' data-heading='Previous Notes'>
                            {% for note in contact.note_set.all %}
                            <div class='note'>
                                {{note.comment}}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>





    <div class='col-md-6 scroll col-full'>
        <div id='message-list'>
            
        </div>
    </div>

    <script src='{% static "js/contact_messages.js" %}'></script>

    <script type="text/javascript">
      // Save to the global namespace
      mw.untranslated_block = "{% include 'contact_blocks/untranslated.html' %}";



    $(function(require) {
        var content = '<p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Nulla tincidunt auctor leo, ut ultricies lectus feugiat id. Duis sagittis erat id varius hendrerit. Etiam et hendrerit lectus. Nullam mattis, mauris vitae vestibulum gravida, enim ante adipiscing leo, sed imperdiet lacus dui bibendum erat. Sed convallis sed leo ac dapibus. Phasellus posuere lobortis euismod. Nam tempor elit ut justo tempor, eget egestas lectus sollicitudin. Cras vehicula sapien quis nisi ultricies rutrum. Nam ornare lorem mollis ullamcorper vestibulum.</p>' +
            '<p>Nullam in vulputate erat, in mattis enim. Curabitur consequat velit a sem ornare adipiscing. Pellentesque nisl lectus, venenatis sed dui ut, placerat mollis urna. Nulla diam diam, consectetur et magna id, lobortis cursus risus. Curabitur feugiat purus sed massa imperdiet rutrum. Mauris eu sodales libero, eu ultrices orci. Nunc vel metus erat. Donec ornare bibendum leo id fermentum. Fusce nec justo consectetur, posuere elit ac, tincidunt odio. Lorem ipsum dolor sit amet, consectetur adipiscing elit.</p>' +
            '<p>Etiam et magna in dui convallis consectetur sit amet sed quam. Vestibulum non libero et justo porttitor cursus nec ac arcu. Aliquam feugiat non ipsum et interdum. Aenean ac lectus erat. Integer vulputate turpis ac accumsan fermentum. Curabitur nec feugiat enim. Nullam lobortis mauris odio, a commodo mauris facilisis quis. Praesent id dapibus lectus. Morbi id blandit magna. Quisque adipiscing viverra massa, vitae sagittis eros dignissim sed. Praesent ornare placerat malesuada. Quisque nec eros dictum, ornare erat non, fringilla felis. Proin sollicitudin arcu ac turpis euismod rhoncus.</p>';
        var delays = ['300', '600', '900', '1200'];
        var jquery = require('jquery');
        var setup = function(selector) {
            $(selector).append(content + content + content);
            $(selector).scrollTop(0);
        };

        require('bootstrap');
        require('fuelux');

        // INFINITE SCROLL
        $('#messagesList').infinitescroll({
            dataSource: function(helpers, callback) {
                setTimeout(function() {
                    callback({
                        content: content
                    });
                }, delays[Math.floor(Math.random() * 4)]);
            }
        });
        setup('#messagesList');
    });
    </script>

    {% endblock %}
